<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viloria Cosmetics</title>

<style>
body{font-family:sans-serif;margin:0;background:#f7f7f7;color:#333}
header{background:#e8c7d6;padding:15px;text-align:center;box-shadow: 0 2px 5px rgba(0,0,0,0.1)}
nav button{margin:5px;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;background:#fff;transition: 0.3s}
nav button:hover{background:#f08ab5;color:#fff}
section{display:none;padding:15px;max-width: 600px;margin: auto}
section.active{display:block}
.card{background:#fff;border-radius:10px;padding:10px;margin-bottom:10px;box-shadow: 0 2px 4px rgba(0,0,0,0.05)}
.product img{width:100%;height:150px;object-fit:cover;border-radius:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
.btn{background:#e38cb7;color:#fff;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;width:100%}
.btn:hover{background:#d17aa5}
.admin{background:#fff0f6}
input,select{width:100%;padding:10px;margin-bottom:8px;border:1px solid #ddd;border-radius:6px;box-sizing: border-box}
.filter{margin-bottom: 15px; text-align: center;}
.filter button{margin:3px; width: auto; display: inline-block}
.small{font-size:12px;color:#666}

.qty{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  margin-top:6px
}
.qty button{padding:4px 10px; border-radius: 4px; border: 1px solid #ddd; background: #fff; cursor: pointer}

.cart-btn{
  margin-top:6px;
  background:#f08ab5;
}

.pay-box{
  background:#fff;
  border-radius:10px;
  padding:15px;
  margin-top:15px;
  border: 2px solid #e8c7d6;
}

/* ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á QR Code */
#qrSection {
  text-align: center;
  display: none;
  margin-top: 15px;
  padding: 10px;
  border: 1px dashed #e38cb7;
  border-radius: 10px;
}
#qrSection img {
  width: 200px;
  height: 200px;
  margin-bottom: 10px;
}
</style>
</head>

<body>

<header>
  <h1>üå∏ Viloria Cosmetics üå∏</h1>
  <nav>
    <button onclick="show('menu')">‡πÄ‡∏°‡∏ô‡∏π</button>
    <button onclick="show('cart')">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
    <button onclick="show('login')">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
    <button onclick="show('admin')">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
  </nav>
</header>

<section id="menu" class="active">
  <h2>‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
  <div class="filter">
    <button class="btn" onclick="filterCategory('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button class="btn" onclick="filterCategory('‡πÄ‡∏°‡∏Ñ‡∏≠‡∏±‡∏û')">‡πÄ‡∏°‡∏Ñ‡∏≠‡∏±‡∏û</button>
    <button class="btn" onclick="filterCategory('‡∏™‡∏Å‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏£‡πå')">‡∏™‡∏Å‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏£‡πå</button>
    <button class="btn" onclick="filterCategory('‡∏ô‡πâ‡∏≥‡∏´‡∏≠‡∏°')">‡∏ô‡πâ‡∏≥‡∏´‡∏≠‡∏°</button>
  </div>
  <div class="grid" id="productList"></div>
</section>

<section id="cart">
  <h2>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
  <div id="cartList"></div>
  <div class="card">
      <p style="font-size: 1.2rem;"><b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</b> <span id="totalSpan" style="color:#e38cb7; font-weight:bold">0</span> ‡∏ö‡∏≤‡∏ó</p>
  </div>

  <div class="pay-box">
    <h3>‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <select id="paymentMethod" onchange="toggleQR()">
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</option>
      <option value="transfer">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</option>
      <option value="promptpay">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</option>
      <option value="cod">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</option>
    </select>

    <div id="qrSection">
        <p><b>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</b></p>
        <img id="qrImage" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=ViloriaCosmeticsPayment" alt="Payment QR Code">
        <p class="small">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
    </div>

    <button class="btn" style="margin-top:10px" onclick="checkout()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
  </div>

  <hr>
  <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
  <div id="orderList"></div>
</section>

<section id="login">
  <h2>‡∏™‡∏°‡∏±‡∏Ñ‡∏£ / ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
  <input id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
  <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
  <div style="display:flex; gap:10px">
      <button class="btn" onclick="register()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      <button class="btn" onclick="login()" style="background:#8cb7e3">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
  <p class="small" id="loginStatus" style="margin-top:10px; text-align:center"></p>
</section>

<section id="admin" class="admin">
  <h2>‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô : ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ & ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
  <div class="card">
      <label class="small">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
      <input type="file" id="imgInput">
      <input id="nameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
      <input id="priceInput" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">
      <select id="categoryInput">
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>
        <option>‡πÄ‡∏°‡∏Ñ‡∏≠‡∏±‡∏û</option>
        <option>‡∏™‡∏Å‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏£‡πå</option>
        <option>‡∏ô‡πâ‡∏≥‡∏´‡∏≠‡∏°</option>
      </select>
      <button class="btn" onclick="addProduct()">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
  </div>

  <hr>
  <div id="adminList"></div>
</section>

<script>
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á <script> ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx8QrdQviU1pxZ8zDE6Hh5Tm5tBxGK7f-wfdsZVHogli4xyplYoVze-z6X645Elgw8W/exec";

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
async function loadDataFromSheet() {
    try {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const pRes = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'fetch', sheet: 'Products' })
        });
        products = await pRes.json();
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
        const oRes = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'fetch', sheet: 'Orders' })
        });
        const fetchedOrders = await oRes.json();
        orders = fetchedOrders.map(o => ({
            ...o,
            items: JSON.parse(o.items) // ‡πÅ‡∏õ‡∏•‡∏á String ‡πÉ‡∏ô Sheet ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Array
        }));

        renderProducts();
        renderOrders();
        renderAdmin();
    } catch (e) {
        console.log("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheet ‡∏´‡∏£‡∏∑‡∏≠ Error:", e);
    }
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô save() ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô Cloud
async function save() {
    // 1. ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô LocalStorage ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏£‡∏≠‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    localStorage.setItem('products', JSON.stringify(products));
    localStorage.setItem('cart', JSON.stringify(cart));
    localStorage.setItem('orders', JSON.stringify(orders));

    // 2. ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Sheets (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Products ‡πÅ‡∏•‡∏∞ Orders)
    fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors', // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
        body: JSON.stringify({ 
            action: 'saveProducts', 
            sheet: 'Products', 
            items: products 
        })
    });
}

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô checkout() ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡∏á Sheet ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
async function checkout() {
    const method = document.getElementById('paymentMethod').value;
    if(cart.length===0) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤');
    if(!method) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');

    const newOrder = {
        user: currentUser || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Guest)',
        items: [...cart],
        payment: method,
        status: '‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå',
        date: new Date().toLocaleString()
    };

    orders.push(newOrder);
    
    // ‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Sheets
    fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({ 
            action: 'addOrder', 
            sheet: 'Orders', 
            ...newOrder 
        })
    });

    alert('‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö Google Sheets ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üéâ');
    cart=[];
    save();
    renderCart();
    renderOrders();
    renderAdmin();
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ loadDataFromSheet() ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
loadDataFromSheet();
let products = JSON.parse(localStorage.getItem('products')) || [];
let cart = JSON.parse(localStorage.getItem('cart')) || [];
let users = JSON.parse(localStorage.getItem('users')) || [];
let orders = JSON.parse(localStorage.getItem('orders')) || [];
let currentUser = localStorage.getItem('currentUser');
let editIndex = null;
let currentCategory = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
renderProducts();
renderCart();
renderOrders();
renderAdmin();
updateLoginStatus();

function show(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function save(){
  localStorage.setItem('products',JSON.stringify(products));
  localStorage.setItem('cart',JSON.stringify(cart));
  localStorage.setItem('users',JSON.stringify(users));
  localStorage.setItem('orders',JSON.stringify(orders));
}

function toggleQR() {
    const method = document.getElementById('paymentMethod').value;
    const qrSection = document.getElementById('qrSection');
    const total = document.getElementById('totalSpan').innerText;
    
    if (method === 'transfer' || method === 'promptpay') {
        qrSection.style.display = 'block';
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR Code ‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ä‡πâ API ‡∏™‡∏£‡πâ‡∏≤‡∏á QR)
        document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=PayTotal_${total}_Baht`;
    } else {
        qrSection.style.display = 'none';
    }
}

function getQty(name){
  const item = cart.find(c=>c.name===name);
  return item ? item.qty : 0;
}

function changeProductQty(name,price,delta){
  let item = cart.find(c=>c.name===name);
  if(item){
    item.qty += delta;
    if(item.qty<=0) cart = cart.filter(c=>c.name!==name);
  }else if(delta>0){
    cart.push({name,price,qty:1});
  }
  save(); renderProducts(); renderCart(); toggleQR();
}

function renderProducts(){
 const productList = document.getElementById('productList');
 productList.innerHTML='';

 products
 .filter(p=>currentCategory==='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'||p.category===currentCategory)
 .forEach((p,index)=>{

   productList.innerHTML+=`
   <div class="product">
     <img src="${p.imgURL || 'https://via.placeholder.com/300'}">
     <b>${p.name}</b>
     <p class="small">${p.category}</p>
     <p style="color:#e38cb7;font-weight:bold">‡∏ø${p.price}</p>

     <div class="qty">
       <button onclick="changeProductQty('${p.name}',${p.price},-1)">‚àí</button>
       <span>${getQty(p.name)}</span>
       <button onclick="changeProductQty('${p.name}',${p.price},1)">+</button>
     </div>

     <button class="btn cart-btn"
       onclick="changeProductQty('${p.name}',${p.price},1)">
       üõí ‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
     </button>

     <hr>
     <button class="btn" style="background:#8cb7e3;margin-top:5px"
       onclick="editProduct(${index})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>

     <button class="btn" style="background:#e36c6c;margin-top:5px"
       onclick="deleteProduct(${index})">üóëÔ∏è ‡∏•‡∏ö</button>
   </div>`;
 });
}

function editProduct(index){
 const p = products[index];

 document.getElementById("nameInput").value = p.name;
 document.getElementById("priceInput").value = p.price;
 document.getElementById("categoryInput").value = p.category;

 editIndex = index;
 show("admin");
}

async function addProduct(){

 const name = document.getElementById("nameInput").value;
 const price = document.getElementById("priceInput").value;
 const category = document.getElementById("categoryInput").value;
 const file = document.getElementById("imgInput").files[0];

 if(!name || !price || !category){
   return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
 }

 let imgURL = editIndex !== null ? products[editIndex].imgURL : "";

 if(file){
   imgURL = await new Promise(resolve=>{
     const reader = new FileReader();
     reader.onload = e => resolve(e.target.result);
     reader.readAsDataURL(file);
   });
 }

 const productData = { name, price, category, imgURL };

 if(editIndex !== null){
   products[editIndex] = productData;

   await fetch(API_URL,{
     method:"POST",
     body:JSON.stringify({
       action:"updateProduct",
       index:editIndex,
       ...productData
     })
   });

   editIndex = null;
   alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");

 }else{
   products.push(productData);

   await fetch(API_URL,{
     method:"POST",
     body:JSON.stringify({
       action:"addProduct",
       ...productData
     })
   });

   alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
 }

 save();
 renderProducts();

 document.getElementById("nameInput").value="";
 document.getElementById("priceInput").value="";
 document.getElementById("categoryInput").value="";
 document.getElementById("imgInput").value="";
}

async function deleteProduct(index){

 if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) return;

 products.splice(index,1);

 await fetch(API_URL,{
   method:"POST",
   body:JSON.stringify({
     action:"deleteProduct",
     index:index
   })
 });

 save();
 renderProducts();

 alert("‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üóëÔ∏è");
}


function renderCart(){
  const cartList = document.getElementById('cartList');
  cartList.innerHTML='';
  let total=0;
  cart.forEach((c,i)=>{
    total+=c.price*c.qty;
    cartList.innerHTML+=`
    <div class="card" style="display:flex; justify-content:space-between; align-items:center">
      <div>
          <b>${c.name}</b><br>
          <span class="small">${c.price}‡∏ø x ${c.qty}</span>
      </div>
      <div class="qty">
        <button onclick="changeProductQty('${c.name}',${c.price},-1)">‚àí</button>
        <span style="min-width:20px; text-align:center">${c.qty}</span>
        <button onclick="changeProductQty('${c.name}',${c.price},1)">+</button>
        <button onclick="cart.splice(${i},1);save();renderProducts();renderCart();toggleQR()" style="color:red; margin-left:10px">üóëÔ∏è</button>
      </div>
    </div>`;
  });
  document.getElementById('totalSpan').innerText=total;
}

function checkout(){
  const method = document.getElementById('paymentMethod').value;
  if(cart.length===0) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤');
  if(!method) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');

  orders.push({
    user: currentUser || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Guest)',
    items: [...cart],
    payment: method,
    status: '‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå',
    date: new Date().toLocaleString()
  });

  alert('‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞ üéâ');
  cart=[];
  save();
  renderCart();
  renderOrders();
  renderAdmin();
  document.getElementById('qrSection').style.display = 'none';
  document.getElementById('paymentMethod').value = '';
}

function renderOrders(){
  const orderList = document.getElementById('orderList');
  orderList.innerHTML='';
  orders.slice().reverse().forEach(o=>{ // ‡πÇ‡∏ä‡∏ß‡πå‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
    orderList.innerHTML+=`
      <div class="card" style="border-left: 5px solid #e8c7d6">
        <div style="display:flex; justify-content:space-between">
            <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span style="color:#e38cb7">${o.status}</span></b>
            <span class="small">${o.date}</span>
        </div>
        <div class="small" style="margin-top:5px">
          ${o.items.map(i=>`${i.name} (x${i.qty})`).join(', ')}
        </div>
        <div class="small"><b>‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢:</b> ${o.payment}</div>
      </div>`;
  });
}

function addProduct(){
  const imgInput = document.getElementById('imgInput');
  const nameInput = document.getElementById('nameInput');
  const priceInput = document.getElementById('priceInput');
  const categoryInput = document.getElementById('categoryInput');

  const img = imgInput.files[0];
  if(!img && editIndex === null) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
  
  const processData = (imgData) => {
    const data={
      name: nameInput.value,
      price: Number(priceInput.value),
      category: categoryInput.value,
      imgURL: imgData || (editIndex !== null ? products[editIndex].imgURL : '')
    };
    if(editIndex===null) products.push(data); else products[editIndex]=data;
    editIndex=null;
    save(); renderProducts(); renderAdmin();
    nameInput.value=priceInput.value=categoryInput.value=imgInput.value='';
  };

  if(img){
    const reader = new FileReader();
    reader.onload=()=> processData(reader.result);
    reader.readAsDataURL(img);
  } else {
    processData();
  }
}

function renderAdmin(){
  const adminList = document.getElementById('adminList');
  adminList.innerHTML='<h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>';
  products.forEach((p,i)=>{
    adminList.innerHTML+=`
    <div class="card" style="display:flex; justify-content:space-between; align-items:center">
      <span>${p.name} (${p.price}‡∏ø)</span>
      <div>
          <button class="btn" style="width:auto; padding:4px 8px; background:#8cb7e3" onclick="editProduct(${i})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn" style="width:auto; padding:4px 8px; background:#ff6b6b" onclick="deleteProduct(${i})">‡∏•‡∏ö</button>
      </div>
    </div>`;
  });

  adminList.innerHTML+=`<hr><h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>`;
  orders.forEach((o,i)=>{
    adminList.innerHTML+=`
      <div class="card">
        <b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${o.user}</b>
        <select onchange="updateOrderStatus(${i}, this.value)">
          <option ${o.status==='‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå'?'selected':''}>‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</option>
          <option ${o.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏û‡πá‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'?'selected':''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏û‡πá‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
          <option ${o.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á'?'selected':''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</option>
          <option ${o.status==='‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß'?'selected':''}>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</option>
        </select>
        <div class="small">${o.items.map(it=>`${it.name} x${it.qty}`).join(', ')}</div>
      </div>`;
  });
}

function editProduct(i){
    editIndex = i;
    const p = products[i];
    document.getElementById('nameInput').value = p.name;
    document.getElementById('priceInput').value = p.price;
    document.getElementById('categoryInput').value = p.category;
    window.scrollTo(0,0);
}

function deleteProduct(i){
    if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?')){
        products.splice(i,1);
        save(); renderProducts(); renderAdmin();
    }
}

function updateOrderStatus(i, status){
    orders[i].status = status;
    save(); renderOrders(); renderAdmin();
}

function filterCategory(c){currentCategory=c;renderProducts();}

function register(){
  const em = document.getElementById('email').value;
  const pw = document.getElementById('password').value;
  if(!em || !pw) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  users.push({email:em, password:pw});
  save(); alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
}

function login(){
  const em = document.getElementById('email').value;
  const pw = document.getElementById('password').value;
  const u=users.find(u=>u.email===em && u.password===pw);
  if(!u)return alert('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  currentUser=u.email;
  localStorage.setItem('currentUser',currentUser);
  updateLoginStatus();
}

function updateLoginStatus(){
  const status = document.getElementById('loginStatus');
  status.innerText=currentUser
    ? `‚úÖ ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢: ${currentUser}`
    : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
}
</script>

</body>
</html>
